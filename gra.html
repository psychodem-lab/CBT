<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wyzwania Umys≈Çu - Trening Psychologiczny</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db; --bg: #f4f7f6; --text: #2c3e50; --card: #ffffff;
            --success: #27ae60; --danger: #e74c3c; --warning: #f1c40f;
        }
        body.dark-mode {
            --bg: #1a1a2e; --text: #e0e0e0; --card: #16213e; --primary: #4cc9f0;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; }
        #app { max-width: 800px; margin: 20px auto; padding: 20px; }
        .card { background: var(--card); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* UI Elements */
        .stats-bar { display: flex; justify-content: space-around; margin-bottom: 20px; font-size: 0.9em; }
        .progress-container { height: 10px; background: #eee; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.5s; }
        .btn { border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; margin: 5px 0; transition: 0.2s; font-weight: bold; }
        .btn-choice { background: #ecf0f1; color: #2c3e50; text-align: left; border: 2px solid transparent; }
        .btn-choice:hover { border-color: var(--primary); background: #e8f4fd; }
        .badge { display: inline-block; padding: 5px 10px; border-radius: 20px; background: var(--warning); font-size: 0.7em; margin: 2px; color: #000; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .hidden { display: none; }
        .timer { font-weight: bold; color: var(--danger); float: right; }
        canvas { max-width: 100%; margin-top: 20px; }
    </style>
</head>
<body class="">

<div id="app">
    <div class="card fade-in" id="hud">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <button onclick="toggleDarkMode()">üåì Tryb</button>
            <div>Energia: <span id="energy-val">100</span>% ‚ö°</div>
            <div>XP: <span id="xp-val">0</span> ‚≠ê</div>
        </div>
        <div class="progress-container"><div id="main-progress" class="progress-fill"></div></div>
    </div>

    <div id="screen-start" class="card fade-in">
        <h1>Wyzwania Umys≈Çu 2.0</h1>
        <p>Wybierz bohatera, aby rozpoczƒÖƒá trening umiejƒôtno≈õci psychologicznych.</p>
        <div id="hero-list"></div>
    </div>

    <div id="screen-game" class="card hidden fade-in">
        <div class="timer" id="timer-box">Czas: <span id="time-left">20</span>s</div>
        <h2 id="story-title"></h2>
        <div id="avatar-container" style="font-size: 50px; text-align: center; margin-bottom: 10px;">üë§</div>
        <p id="story-text"></p>
        <div id="inventory" style="margin-bottom: 15px;"></div>
        <div id="choices-container"></div>
        <div id="feedback-box" class="hidden" style="margin-top: 20px; padding: 15px; border-radius: 8px;"></div>
    </div>

    <div id="screen-reflection" class="card hidden fade-in">
        <h3>Dziennik Refleksji</h3>
        <p>Zanim sprawdzisz wynik, opisz kr√≥tko: co czu≈Çe≈õ w tej sytuacji?</p>
        <textarea id="reflection-input" style="width: 100%; height: 100px; margin-bottom: 10px;"></textarea>
        <button class="btn" style="background: var(--success); color: white;" onclick="finalizeLevel()">Dalej</button>
    </div>

    <div id="screen-results" class="card hidden fade-in">
        <h2>Wynik Treningu</h2>
        <div id="badges-container"></div>
        <canvas id="statsChart"></canvas>
        <div id="theory-module" style="margin-top: 20px; font-size: 0.9em; border-top: 1px solid #ddd; padding-top: 15px;"></div>
        <button class="btn" style="background: var(--primary); color: white; margin-top: 20px;" onclick="location.reload()">Zagraj od nowa</button>
    </div>
</div>

<script>
    // Baza danych gry (Implementacja punkt√≥w 3, 4, 8, 11, 20)
    const heroes = [
        { id: 'marek', name: 'Marek', difficulty: '≈Åatwy', skill: 'Asertywno≈õƒá', icon: 'üò°' },
        { id: 'ania', name: 'Ania', difficulty: '≈öredni', skill: 'Lƒôk Spo≈Çeczny', icon: 'üò∞' },
        { id: 'kasia', name: 'Kasia', difficulty: 'Trudny', skill: 'Granice/NVC', icon: 'üòê' }
    ];

    const scenarios = {
        marek: [
            {
                text: "Grupa znajomych ≈õmieje siƒô z Twojego hobby (szachy). M√≥wiƒÖ: 'Ale nuda, id≈∫ do biblioteki'. Co robisz?",
                timer: 15,
                choices: [
                    { text: "M√≥wiƒô: 'Sami jeste≈õcie nudni' i odchodzƒô.", type: 'agresja', xp: 5, energy: -10, feedback: "To agresja obronna. Zamyka drogƒô do dialogu." },
                    { text: "U≈õmiecham siƒô sztucznie i zmieniam temat.", type: 'uleg≈Ço≈õƒá', xp: 2, energy: -20, feedback: "Uleg≈Ço≈õƒá. Twoje pasje sƒÖ wa≈ºne, nie musisz ich ukrywaƒá." },
                    { text: "M√≥wiƒô: 'Lubiƒô szachy, dajƒÖ mi satysfakcjƒô. Rozumiem, ≈ºe dla Was to nuda, ale proszƒô o szacunek'.", type: 'asertywno≈õƒá', xp: 20, energy: 0, feedback: "≈öwietnie! To postawa asertywna.", tool: "Komunikat JA" }
                ]
            }
        ],
        ania: [
            {
                text: "Masz wyg≈Çosiƒá prezentacjƒô. Czujesz parali≈ºujƒÖcy lƒôk. Twoja pierwsza my≈õl: 'Zaraz zemdlejƒô, wszyscy zobaczƒÖ jak siƒô trzƒôsƒô'.",
                timer: 20,
                choices: [
                    { text: "Uciekam pod pretekstem choroby.", type: 'uleg≈Ço≈õƒá', xp: 0, energy: -30, feedback: "Unikanie wzmacnia lƒôk w d≈Çu≈ºszej perspektywie." },
                    { text: "U≈ºywam techniki oddechowej 4-7-8 i idƒô na ≈õrodek.", type: 'asertywno≈õƒá', xp: 25, energy: -5, feedback: "Dzia≈Çanie mimo lƒôku to odwaga. Oddech uspokaja cia≈Ço.", tool: "Oddech 4-7-8" },
                    { text: "Wmawiam sobie: 'Nie my≈õl o tym, bƒÖd≈∫ twarda'.", type: 'agresja', xp: 5, energy: -15, feedback: "T≈Çumienie emocji zwiƒôksza napiƒôcie." }
                ]
            }
        ]
    };

    // Stan gry (Implementacja 1, 2, 5, 9, 27)
    let state = {
        xp: parseInt(localStorage.getItem('psyXP')) || 0,
        energy: 100,
        currentHero: null,
        currentStep: 0,
        stats: { asertywno≈õƒá: 0, uleg≈Ço≈õƒá: 0, agresja: 0 },
        inventory: [],
        timer: null
    };

    function init() {
        document.getElementById('xp-val').innerText = state.xp;
        const list = document.getElementById('hero-list');
        heroes.forEach(h => {
            list.innerHTML += `<div class="btn btn-choice" onclick="startHero('${h.id}')">${h.icon} <b>${h.name}</b> - Wyzwanie: ${h.skill} (${h.difficulty})</div>`;
        });
    }

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }

    function startHero(heroId) {
        state.currentHero = heroId;
        state.currentStep = 0;
        document.getElementById('screen-start').classList.add('hidden');
        document.getElementById('screen-game').classList.remove('hidden');
        renderStep();
    }

    function renderStep() {
        const step = scenarios[state.currentHero][state.currentStep];
        document.getElementById('story-title').innerText = `Scenariusz: ${state.currentHero.toUpperCase()}`;
        document.getElementById('story-text').innerText = step.text;
        document.getElementById('avatar-container').innerText = heroes.find(h => h.id === state.currentHero).icon;
        
        const container = document.getElementById('choices-container');
        container.innerHTML = '';
        step.choices.forEach((c, idx) => {
            container.innerHTML += `<button class="btn btn-choice" onclick="makeChoice(${idx})">${c.text}</button>`;
        });

        startTimer(step.timer);
    }

    function startTimer(seconds) {
        let left = seconds;
        document.getElementById('time-left').innerText = left;
        clearInterval(state.timer);
        state.timer = setInterval(() => {
            left--;
            document.getElementById('time-left').innerText = left;
            if (left <= 0) {
                clearInterval(state.timer);
                alert("Czas minƒÖ≈Ç! Wybierz cokolwiek intuicyjnie.");
            }
        }, 1000);
    }

    function makeChoice(idx) {
        clearInterval(state.timer);
        const choice = scenarios[state.currentHero][state.currentStep].choices[idx];
        
        state.xp += choice.xp;
        state.energy += choice.energy;
        state.stats[choice.type]++;
        if (choice.tool) state.inventory.push(choice.tool);

        updateHUD();

        const fb = document.getElementById('feedback-box');
        fb.innerHTML = `<strong>${choice.type.toUpperCase()}</strong>: ${choice.feedback}`;
        fb.className = `fade-in ${choice.type === 'asertywno≈õƒá' ? 'correct' : 'wrong'}`;
        fb.classList.remove('hidden');

        setTimeout(() => {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-reflection').classList.remove('hidden');
        }, 2000);
    }

    function updateHUD() {
        document.getElementById('xp-val').innerText = state.xp;
        document.getElementById('energy-val').innerText = state.energy;
        document.getElementById('main-progress').style.width = (state.energy) + '%';
        localStorage.setItem('psyXP', state.xp);
    }

    function finalizeLevel() {
        document.getElementById('screen-reflection').classList.add('hidden');
        document.getElementById('screen-results').classList.remove('hidden');
        
        // Render Wykresu (Punkt 27)
        const ctx = document.getElementById('statsChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Asertywno≈õƒá', 'Uleg≈Ço≈õƒá', 'Agresja'],
                datasets: [{
                    data: [state.stats.asertywno≈õƒá, state.stats.uleg≈Ço≈õƒá, state.stats.agresja],
                    backgroundColor: ['#27ae60', '#f1c40f', '#e74c3c']
                }]
            }
        });

        // Modu≈Ç teorii (Punkt 11, 20)
        document.getElementById('theory-module').innerHTML = `
            <h4>Pigu≈Çka Wiedzy:</h4>
            <blockquote>Asertywno≈õƒá to nie tylko odmawianie. To umiejƒôtno≈õƒá wyra≈ºania swoich my≈õli i uczuƒá przy jednoczesnym poszanowaniu granic innych os√≥b. 
            Wed≈Çug bada≈Ñ (Alberti & Emmons, 2017), trening asertywno≈õci obni≈ºa poziom kortyzolu. <br>
            <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3584580/" target="_blank">Zobacz badanie o CBT</a></blockquote>
        `;
    }

    init();
</script>

</body>
</html>
